<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>nexi-cli</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
            integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <style>
            /* Add this CSS to your stylesheet */
            .button {
                width: 89px;
                height: 50px;
            }
            .control.has-icons-left .icon.is-left,
            .control.has-icons-left .input:hover ~ .icon,
            .control.has-icons-left .select:hover ~ .icon,
            .control.has-icons-right .input:hover ~ .icon,
            .control.has-icons-right .select:hover ~ .icon {
                color: var(--bulma-input-icon-focus-color);
            }
        </style>
    </head>
    <body>
        <div class="columns is-centered">
            <div class="column is-narrow">
                <div class="column">
                    <div class="columns is-mobile is-vcentered is-centered m-2">
                        <h3 class="subtitle is-size-4">Test Cards</h3>
                    </div>
                    <ul class="m-5">
                        <li>
                            <div
                                class="columns is-mobile is-vcentered is-centered"
                            >
                                <div class="column is-narrow">
                                    <p class="control has-icons-left">
                                        <input
                                            class="input is-medium is-primary readonly"
                                            placeholder="4268 2700 8737 4847"
                                            readonly
                                        />
                                        <span class="icon is-small is-left">
                                            <i class="fa-brands fa-cc-visa"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="column is-narrow">
                                    <button
                                        onclick="copyToClipboard('4268270087374847', this)"
                                        class="button copy-button is-medium"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div
                                class="columns is-mobile is-vcentered is-centered"
                            >
                                <div class="column is-narrow">
                                    <p class="control has-icons-left">
                                        <input
                                            class="input is-medium is-warning readonly"
                                            placeholder="4925 0000 0000 0061"
                                            readonly
                                        />
                                        <span class="icon is-small is-left">
                                            <i class="fa-brands fa-cc-visa"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="column is-narrow">
                                    <button
                                        onclick="copyToClipboard('4925000000000061', this)"
                                        class="button copy-button is-medium"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div
                                class="columns is-mobile is-vcentered is-centered"
                            >
                                <div class="column is-narrow">
                                    <p class="control has-icons-left">
                                        <input
                                            class="input is-medium is-warning readonly"
                                            placeholder="4925 0000 0000 0079"
                                            readonly
                                        />
                                        <span class="icon is-small is-left">
                                            <i class="fa-brands fa-cc-visa"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="column is-narrow">
                                    <button
                                        onclick="copyToClipboard('4925000000000079', this)"
                                        class="button copy-button is-medium"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div
                                class="columns is-mobile is-vcentered is-centered"
                            >
                                <div class="column is-narrow">
                                    <p class="control has-icons-left">
                                        <input
                                            class="input is-medium is-danger readonly"
                                            placeholder="4925 0000 0000 0087"
                                            readonly
                                        />
                                        <span class="icon is-small is-left">
                                            <i class="fa-brands fa-cc-visa"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="column is-narrow">
                                    <button
                                        onclick="copyToClipboard('4925000000000087', this)"
                                        class="button copy-button is-medium"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div
                                class="columns is-mobile is-vcentered is-centered"
                            >
                                <div class="column is-narrow">
                                    <p class="control has-icons-left">
                                        <input
                                            class="input is-medium is-primary readonly"
                                            placeholder="5213 1998 0345 3465"
                                            readonly
                                        />
                                        <span class="icon is-small is-left">
                                            <i
                                                class="fa-brands fa-cc-mastercard"
                                            ></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="column is-narrow">
                                    <button
                                        onclick="copyToClipboard('5213199803453465', this)"
                                        class="button copy-button is-medium"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div
                                class="columns is-mobile is-vcentered is-centered"
                            >
                                <div class="column is-narrow">
                                    <p class="control has-icons-left">
                                        <input
                                            class="input is-medium is-primary readonly"
                                            placeholder="5544 3300 0000 0235"
                                            readonly
                                        />
                                        <span class="icon is-small is-left">
                                            <i
                                                class="fa-brands fa-cc-mastercard"
                                            ></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="column is-narrow">
                                    <button
                                        onclick="copyToClipboard('5544330000000235', this)"
                                        class="button copy-button is-medium"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div
                                class="columns is-mobile is-vcentered is-centered"
                            >
                                <div class="column is-narrow">
                                    <p class="control has-icons-left">
                                        <input
                                            class="input is-medium is-primary readonly"
                                            placeholder="3762 0600 0000 009"
                                            readonly
                                        />
                                        <span class="icon is-small is-left">
                                            <i class="fa-brands fa-cc-amex"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="column is-narrow">
                                    <button
                                        onclick="copyToClipboard('376206000000009', this)"
                                        class="button copy-button is-medium"
                                    >
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Right Column -->
            <div class="column">
                <div id="iframe-container"></div>
            </div>
        </div>
        <script>
            // Global variable to store the checkout instance
            let checkout = null;

            // Function to clean up the checkout instance
            function cleanupCheckout() {
                if (checkout) {
                    checkout.cleanup();
                    sendEvent('checkout.cleanup()');

                    // Remove the iframe from the container
                    const iframeContainer =
                        document.getElementById('iframe-container');
                    while (iframeContainer.firstChild) {
                        iframeContainer.removeChild(iframeContainer.firstChild);
                    }
                }
            }

            // Function to send events to the server
            function sendEvent(event, value = null) {
                fetch('event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ event, value }),
                });
            }

            // Function to initialize the checkout
            function initializeCheckout(config) {
                document.title = `nexi-cli ${config.paymentId}`;

                var checkoutJS = document.createElement('script');
                if (config.production) {
                    checkoutJS.setAttribute(
                        'src',
                        'https://checkout.dibspayment.eu/v1/checkout.js?v=1'
                    );
                } else {
                    checkoutJS.setAttribute(
                        'src',
                        'https://test.checkout.dibspayment.eu/v1/checkout.js?v=1'
                    );
                }

                document.head.appendChild(checkoutJS);

                // Wait for the script to load before creating the checkout object
                checkoutJS.onload = () => {
                    console.log('Checkout script has been loaded!');

                    // Define the checkout options
                    const checkoutOptions = {
                        checkoutKey: config.checkoutKey,
                        paymentId: config.paymentId,
                        language: config.language,
                        containerId: 'iframe-container',
                    };

                    // Create the checkout object after the script has loaded
                    const checkout = new Dibs.Checkout(checkoutOptions);

                    // Optionally, you can perform additional actions with the checkout object here
                    console.log('Checkout object created:', checkout);

                    const iframe = document.getElementById(
                        'nets-checkout-iframe'
                    );

                    // Publish event when iframe has loaded
                    iframe.addEventListener('load', () => {
                        sendEvent('iframe-loaded');
                    });

                    // Handle address-changed event
                    checkout.on('address-changed', address => {
                        sendEvent('address-changes', address);
                    });

                    // Handle pay-initialized event
                    checkout.on('pay-initialized', paymentId => {
                        sendEvent('pay-initialized');
                        checkout.send('payment-order-finalized', true);
                        sendEvent('payment-order-finalized', true);
                    });

                    // Handle payment-completed event
                    checkout.on('payment-completed', response => {
                        console.log('payment-completed raised');
                        sendEvent('payment-completed');
                    });

                    // Apply the initial theme to the checkout
                    applyCheckoutTheme(checkout);
                };
                // Handle script loading errors
                checkoutJS.onerror = () => {
                    console.error('Failed to load the checkout script.');
                };
            }

            // Function to fetch configuration and initialize checkout
            function fetchAndInitializeCheckout() {
                fetch('/data', { method: 'GET' })
                    .then(response => response.json())
                    .then(config => initializeCheckout(config))
                    .catch(error => console.error('Error:', error));
            }

            // Function to copy text to clipboard
            function copyToClipboard(text, button) {
                const originalText = button.innerHTML; // Store the original text
                const originalClass = button.className;

                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        console.log('Text copied to clipboard:', text);
                        button.innerHTML =
                            '<span class="icon"><i class="fa-solid fa-check"></i></span>'; // Show only the checkmark icon
                        button.classList.add('is-success');
                        // Set a timeout to revert the button text after 1 second
                        setTimeout(() => {
                            button.innerHTML = originalText; // Revert to the original text
                            button.className = originalClass;
                        }, 1000); // 1000 milliseconds = 1 second
                    })
                    .catch(err => {
                        console.error('Could not copy text: ', err);
                    });
            }

            // Function to apply the theme to the checkout
            function applyCheckoutTheme(checkout) {
                const theme = document.documentElement.classList.contains(
                    'dark'
                )
                    ? {
                          useLightIcons: true,
                          backgroundColor: 'rgb(20, 22, 26)',
                          panelColor: 'rgb(36, 41, 46)',
                          textColor: 'rgb(200,200,200)',
                          panelTextColor: 'rgb(200,200,200)',
                          primaryColor: 'rgb(102, 120, 255)',
                          linkColor: 'rgb(102, 120, 255)',
                          buttonbackgroundColor: 'rgb(102, 120, 255)',
                          primaryOutlineColor: 'rgb(102, 120, 255)',
                          outlineColor: 'rgb(31, 34, 41)',
                          panelLinkColor: 'rgb(102, 120, 255)',
                      }
                    : 'light';
                checkout.setTheme(theme);
            }

            // Function to set the theme based on user preference or system settings
            function setTheme() {
                const prefersDarkMode = window.matchMedia(
                    '(prefers-color-scheme: dark)'
                ).matches;
                const savedTheme = localStorage.currentTheme;

                // Determine the theme to apply
                if (savedTheme === 'dark' || (!savedTheme && prefersDarkMode)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            // Example functions to explicitly set the theme
            function setLightTheme() {
                localStorage.currentTheme = 'light';
                setTheme();
            }

            function setDarkTheme() {
                localStorage.currentTheme = 'dark';
                setTheme();
            }

            function resetThemeToSystem() {
                localStorage.removeItem('currentTheme');
                setTheme();
            }

            // Initialize everything on document load
            document.addEventListener('DOMContentLoaded', () => {
                cleanupCheckout();
                fetchAndInitializeCheckout();
                setTheme();
            });
        </script>
    </body>
</html>
